---
:tests:
  test_invalid_noop_response_is_ignored:
    :response: "* NOOP\r\n"
    :expected: !ruby/struct:Net::IMAP::IgnoredResponse
      name: "NOOP"
      data:
      raw_data: "* NOOP\r\n"

  test_invalid_noop_response_with_unparseable_data:
    :response: "* NOOP froopy snood\r\n"
    :expected: !ruby/struct:Net::IMAP::IgnoredResponse
      name: "NOOP"
      data: !ruby/struct:Net::IMAP::UnparsedData
        unparsed_data: "froopy snood"
      raw_data: "* NOOP froopy snood\r\n"

  test_invalid_noop_response_with_numeric_prefix:
    :response: "* 99 NOOP\r\n"
    :expected: !ruby/struct:Net::IMAP::IgnoredResponse
      name: "NOOP"
      data: 99
      raw_data: "* 99 NOOP\r\n"

  test_invalid_noop_response_with_numeric_prefix_and_unparseable_data:
    :response: "* 86 NOOP froopy snood\r\n"
    :expected: !ruby/struct:Net::IMAP::IgnoredResponse
      name: "NOOP"
      data: !ruby/struct:Net::IMAP::UnparsedNumericResponseData
        number: 86
        unparsed_data: "froopy snood"
      raw_data: "* 86 NOOP froopy snood\r\n"

  "Microsoft Exchange issues an invalid resp-text-code":
    comment: |
      net-imap issue: https://github.com/ruby/net-imap/issues/597

      Microsoft Exchange is issuing an invalid resp-text-code, but net-imap
      should fallback to `resp-text = text` when resp-text-code fails to parse.
    :response: "RUBY0001 OK [Error=\"Microsoft.Exchange.Data.Storage.WrongServerException:
      Cross Server access is not allowed for mailbox xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"
      AuthResultFromPopImapEnd=0 Proxy=XXXXXXXXXXXXX.EURXXXX.PROD.OUTLOOK.COM:1993:SSL
      MailboxBE=XXXXXXXXXXXXX.EURXXXX.PROD.OUTLOOK.COM
      Service=Imap4] AUTHENTICATE completed.\r\n"
    :expected: !ruby/struct:Net::IMAP::TaggedResponse
      tag: RUBY0001
      name: OK
      data: !ruby/struct:Net::IMAP::ResponseText
        code:
        text: '[Error="Microsoft.Exchange.Data.Storage.WrongServerException: Cross Server
          access is not allowed for mailbox xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" AuthResultFromPopImapEnd=0
          Proxy=XXXXXXXXXXXXX.EURXXXX.PROD.OUTLOOK.COM:1993:SSL MailboxBE=XXXXXXXXXXXXX.EURXXXX.PROD.OUTLOOK.COM
          Service=Imap4] AUTHENTICATE completed.'
      raw_data: "RUBY0001 OK [Error=\"Microsoft.Exchange.Data.Storage.WrongServerException:
        Cross Server access is not allowed for mailbox xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"
        AuthResultFromPopImapEnd=0 Proxy=XXXXXXXXXXXXX.EURXXXX.PROD.OUTLOOK.COM:1993:SSL
        MailboxBE=XXXXXXXXXXXXX.EURXXXX.PROD.OUTLOOK.COM Service=Imap4] AUTHENTICATE
        completed.\r\n"

  "Outlook.com and Microsoft 365 can send an invalid COPYUID response code":
    comment: |
      Although this is a buggy COPYUID response from the server, it's still a
      valid *generic* `resp-text-code`.  We should always successfully parse
      `resp-text-code` when it begins with a valid `atom SP`, even if that means
      using UnparsedData or some other similar class to wrap the invalid or
      unparsable payload that follows.
    :response: "* OK [COPYUID 701  ]\r\n"
    :expected: !ruby/struct:Net::IMAP::UntaggedResponse
      name: OK
      data: !ruby/struct:Net::IMAP::ResponseText
        code: !ruby/struct:Net::IMAP::ResponseCode
          name: COPYUID
          data: !ruby/data:Net::IMAP::InvalidParseData
            parse_error: !ruby/exception:Net::IMAP::ResponseParseError
              message: unexpected token SPACE (expected ATOM or NUMBER or STAR)
              parser_class: !ruby/class 'Net::IMAP::ResponseParser'
              string: "* OK [COPYUID 701  ]\r\n"
              pos: 19
              lex_state: :EXPR_BEG
              token: !ruby/struct:Net::IMAP::ResponseParser::Token
                symbol: :SPACE
                value: " "
              backtrace:
              - "lib/net/imap/response_parser/parser_utils.rb:218:in `parse_error'"
              - "lib/net/imap/response_parser/parser_utils.rb:127:in `combine_adjacent'"
              - "lib/net/imap/response_parser.rb:499:in `sequence_set'"
              - "lib/net/imap/response_parser.rb:2180:in `uid_set'"
              - "lib/net/imap/response_parser.rb:2034:in `resp_code_copy__data'"
              - "lib/net/imap/response_parser.rb:1973:in `resp_text_code'"
              - "lib/net/imap/response_parser.rb:1894:in `resp_text'"
              - "lib/net/imap/response_parser.rb:820:in `resp_cond_state'"
              - "lib/net/imap/response_parser.rb:824:in `resp_cond_state__untagged'"
              - "lib/net/imap/response_parser.rb:740:in `response_data'"
              - "lib/net/imap/response_parser.rb:687:in `response'"
              - "lib/net/imap/response_parser.rb:40:in `parse'"
              - "test/net/imap/net_imap_test_helpers.rb ... ignoring 3 frames"
              - "/gems/test-unit-3.7.3/lib/test/unit/... ignoring 42 frames"
            unparsed_data: '701  '
            parsed_data:
        text: ""
      raw_data: "* OK [COPYUID 701  ]\r\n"

  "Extra resp-text-code payload":
    comment: |
      `resp-text-code` should parse when its payload continues unexpectedly.
    :response: "* OK [COPYUID 1 1:10 101:110 extra junk] bad\r\n"
    :expected: !ruby/struct:Net::IMAP::UntaggedResponse
      name: OK
      data: !ruby/struct:Net::IMAP::ResponseText
        code: !ruby/struct:Net::IMAP::ResponseCode
          name: COPYUID
          data: !ruby/data:Net::IMAP::InvalidParseData
            parse_error: !ruby/exception:Net::IMAP::ResponseParseError
              message: expected resp-text-code "COPYUID" to be complete
              backtrace:
              - "lib/net/imap/response_parser/parser_utils.rb:218:in 'Net::IMAP::ResponseParser::ParserUtils#parse_error'"
              - "lib/net/imap/response_parser.rb:1981:in 'Net::IMAP::ResponseParser#resp_text_code'"
              - "lib/net/imap/response_parser.rb:1894:in 'Net::IMAP::ResponseParser#resp_text'"
              - "lib/net/imap/response_parser.rb:820:in 'Net::IMAP::ResponseParser#resp_cond_state'"
              - "lib/net/imap/response_parser.rb:824:in 'Net::IMAP::ResponseParser#resp_cond_state__untagged'"
              - "lib/net/imap/response_parser.rb:740:in 'Net::IMAP::ResponseParser#response_data'"
              - "lib/net/imap/response_parser.rb:687:in 'Net::IMAP::ResponseParser#response'"
              - "lib/net/imap/response_parser.rb:40:in 'Net::IMAP::ResponseParser#parse'"
              - "test/net/imap/net_imap_test_helpers.rb ... ignoring 3 frames"
              - "/gems/test-unit-3.7.3/lib/test/unit/... ignoring 42 frames"
              parser_class: !ruby/class 'Net::IMAP::ResponseParser'
              string: "* OK [COPYUID 1 1:10 101:110 extra junk] bad\r\n"
              pos: 29
              lex_state: :EXPR_BEG
              token: !ruby/struct:Net::IMAP::ResponseParser::Token
                symbol: :SPACE
                value: " "
            unparsed_data: 1 1:10 101:110 extra junk
            parsed_data: !ruby/data:Net::IMAP::CopyUIDData
              uidvalidity: 1
              source_uids: !ruby/object:Net::IMAP::SequenceSet
                string: '1:10'
              assigned_uids: !ruby/object:Net::IMAP::SequenceSet
                string: 101:110
        text: bad
      raw_data: "* OK [COPYUID 1 1:10 101:110 extra junk] bad\r\n"

  "Missing resp-text-code payload":
    comment: |
      `resp-text-code` should parse even when its expected payload is missing.
    :response: "* OK [COPYUID] missing\r\n"
    :expected: !ruby/struct:Net::IMAP::UntaggedResponse
      name: OK
      data: !ruby/struct:Net::IMAP::ResponseText
        code: !ruby/struct:Net::IMAP::ResponseCode
          name: COPYUID
          data: !ruby/data:Net::IMAP::InvalidParseData
            parse_error: !ruby/exception:Net::IMAP::ResponseParseError
              message: unexpected RBRA (expected " ")
              backtrace:
              - "lib/net/imap/response_parser/parser_utils.rb:218:in 'Net::IMAP::ResponseParser::ParserUtils#parse_error'"
              - "lib/net/imap/response_parser/parser_utils.rb:54:in 'Net::IMAP::ResponseParser#SP!'"
              - "lib/net/imap/response_parser.rb:1973:in 'Net::IMAP::ResponseParser#resp_text_code'"
              - "lib/net/imap/response_parser.rb:1894:in 'Net::IMAP::ResponseParser#resp_text'"
              - "lib/net/imap/response_parser.rb:820:in 'Net::IMAP::ResponseParser#resp_cond_state'"
              - "lib/net/imap/response_parser.rb:824:in 'Net::IMAP::ResponseParser#resp_cond_state__untagged'"
              - "lib/net/imap/response_parser.rb:740:in 'Net::IMAP::ResponseParser#response_data'"
              - "lib/net/imap/response_parser.rb:687:in 'Net::IMAP::ResponseParser#response'"
              - "lib/net/imap/response_parser.rb:40:in 'Net::IMAP::ResponseParser#parse'"
              - "test/net/imap/net_imap_test_helpers.rb ... ignoring 3 frames"
              - "/gems/test-unit-3.7.3/lib/test/unit/... ignoring 42 frames"
              parser_class: !ruby/class 'Net::IMAP::ResponseParser'
              string: "* OK [COPYUID] missing\r\n"
              pos: 14
              lex_state: :EXPR_BEG
              token: !ruby/struct:Net::IMAP::ResponseParser::Token
                symbol: :RBRA
                value: "]"
            unparsed_data:
            parsed_data:
        text: missing
      raw_data: "* OK [COPYUID] missing\r\n"

  "Unexpected resp-text-code payload":
    comment: |
      `resp-text-code` should parse even when a payload is unexpectedly present.
    :response: "* OK [CLOSED shouldn't be anything here] mailbox closed\r\n"
    :expected: !ruby/struct:Net::IMAP::UntaggedResponse
      name: OK
      data: !ruby/struct:Net::IMAP::ResponseText
        code: !ruby/struct:Net::IMAP::ResponseCode
          name: CLOSED
          data: !ruby/data:Net::IMAP::InvalidParseData
            parse_error: !ruby/exception:Net::IMAP::ResponseParseError
              message: expected resp-text-code "CLOSED" to be complete
              backtrace:
              - "lib/net/imap/response_parser/parser_utils.rb:218:in 'Net::IMAP::ResponseParser::ParserUtils#parse_error'"
              - "lib/net/imap/response_parser.rb:1981:in 'Net::IMAP::ResponseParser#resp_text_code'"
              - "lib/net/imap/response_parser.rb:1894:in 'Net::IMAP::ResponseParser#resp_text'"
              - "lib/net/imap/response_parser.rb:820:in 'Net::IMAP::ResponseParser#resp_cond_state'"
              - "lib/net/imap/response_parser.rb:824:in 'Net::IMAP::ResponseParser#resp_cond_state__untagged'"
              - "lib/net/imap/response_parser.rb:740:in 'Net::IMAP::ResponseParser#response_data'"
              - "lib/net/imap/response_parser.rb:687:in 'Net::IMAP::ResponseParser#response'"
              - "lib/net/imap/response_parser.rb:40:in 'Net::IMAP::ResponseParser#parse'"
              - "test/net/imap/net_imap_test_helpers.rb ... ignoring 3 frames"
              - "/gems/test-unit-3.7.3/lib/test/unit/... ignoring 42 frames"
              parser_class: !ruby/class 'Net::IMAP::ResponseParser'
              string: "* OK [CLOSED shouldn't be anything here] mailbox closed\r\n"
              pos: 13
              lex_state: :EXPR_BEG
              token: !ruby/struct:Net::IMAP::ResponseParser::Token
                symbol: :SPACE
                value: " "
            unparsed_data: shouldn't be anything here
            parsed_data:
        text: mailbox closed
      raw_data: "* OK [CLOSED shouldn't be anything here] mailbox closed\r\n"

  outlook.com puts an extra SP in ENVELOPE address lists:
    comment: |
      An annoying bug from outlook.com.  They've had the bug for years, and
      still have the bug as of 2023-11-28.

      The example comes from a real response, but all addresses have been
      replaced by the `faker` gem. :)
    :response: "* 24 FETCH (UID 60 INTERNALDATE \"24-May-2021 11:47:51 +0200\" RFC822.SIZE 49051 ENVELOPE (\"Mon, 24 May 20 21 09:47:50 +0000\" \"Zoooom Zoom\" ((\"Augustina Gleason\" NIL \"augustina\" \"oberbrunner.test\")) NIL NIL ((\"risa@harvey-lemke.test\" NIL \"risa\" \"harvey-lemke.test\") (\"shella@kilback-renner.test\" NIL \"shella\" \"kilback-renner.test\") (\"jana.kiehn@bradtke-considine.example\" NIL \"jana.kiehn\" \"bradtke-considine.example\") (\"frank@hartmann.test\" NIL \"frank\" \"hartmann.test\") (\"numbers.ryan@satterfield.test\" NIL \"numbers.ryan\" \"satterfield.test\") (\"keneth_feeney@will-walter.test\" NIL \"keneth_feeney\" \"will-walter.test\")) NIL NIL NIL \"<aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@bbbbbbbbbbbbb.ccccccc.PROD.OUTLOOK.COM>\"))\r\n"
    :expected: !ruby/struct:Net::IMAP::UntaggedResponse
      name: FETCH
      data: !ruby/struct:Net::IMAP::FetchData
        seqno: 24
        attr:
          UID: 60
          INTERNALDATE: 24-May-2021 11:47:51 +0200
          RFC822.SIZE: 49051
          ENVELOPE: !ruby/struct:Net::IMAP::Envelope
            date: Mon, 24 May 20 21 09:47:50 +0000
            subject: Zoooom Zoom
            from:
            - !ruby/struct:Net::IMAP::Address
              name: Augustina Gleason
              route:
              mailbox: augustina
              host: oberbrunner.test
            sender:
            reply_to:
            to:
            - !ruby/struct:Net::IMAP::Address
              name: risa@harvey-lemke.test
              route:
              mailbox: risa
              host: harvey-lemke.test
            - !ruby/struct:Net::IMAP::Address
              name: shella@kilback-renner.test
              route:
              mailbox: shella
              host: kilback-renner.test
            - !ruby/struct:Net::IMAP::Address
              name: jana.kiehn@bradtke-considine.example
              route:
              mailbox: jana.kiehn
              host: bradtke-considine.example
            - !ruby/struct:Net::IMAP::Address
              name: frank@hartmann.test
              route:
              mailbox: frank
              host: hartmann.test
            - !ruby/struct:Net::IMAP::Address
              name: numbers.ryan@satterfield.test
              route:
              mailbox: numbers.ryan
              host: satterfield.test
            - !ruby/struct:Net::IMAP::Address
              name: keneth_feeney@will-walter.test
              route:
              mailbox: keneth_feeney
              host: will-walter.test
            cc:
            bcc:
            in_reply_to:
            message_id: "<aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@bbbbbbbbbbbbb.ccccccc.PROD.OUTLOOK.COM>"
      raw_data: "* 24 FETCH (UID 60 INTERNALDATE \"24-May-2021 11:47:51 +0200\" RFC822.SIZE
        49051 ENVELOPE (\"Mon, 24 May 20 21 09:47:50 +0000\" \"Zoooom Zoom\" ((\"Augustina
        Gleason\" NIL \"augustina\" \"oberbrunner.test\")) NIL NIL ((\"risa@harvey-lemke.test\"
        NIL \"risa\" \"harvey-lemke.test\") (\"shella@kilback-renner.test\" NIL \"shella\"
        \"kilback-renner.test\") (\"jana.kiehn@bradtke-considine.example\" NIL \"jana.kiehn\"
        \"bradtke-considine.example\") (\"frank@hartmann.test\" NIL \"frank\" \"hartmann.test\")
        (\"numbers.ryan@satterfield.test\" NIL \"numbers.ryan\" \"satterfield.test\")
        (\"keneth_feeney@will-walter.test\" NIL \"keneth_feeney\" \"will-walter.test\"))
        NIL NIL NIL \"<aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@bbbbbbbbbbbbb.ccccccc.PROD.OUTLOOK.COM>\"))\r\n"

  imap.gmail.com allows invalid atom-specials in flags:
    comment: |
      Upstream bug report: https://issuetracker.google.com/issues/315160951
      net-imap issue: https://github.com/ruby/net-imap/issues/241
    :response: "* FLAGS (\\Answered \\Flagged \\Draft \\Deleted \\Seen $Forwarded $Junk
      $MailFlagBit0 $MailFlagBit2 $NotJunk $NotPhishing $Phishing Forwarded
      JunkRecorded NotJunk OIB-Seen-INBOX OIB-Seen-Unsubscribe
      OIB-Seen-[Google Mail]/Alle Nachrichten)\r\n"
    :expected: !ruby/struct:Net::IMAP::UntaggedResponse
      name: FLAGS
      data:
      - :Answered
      - :Flagged
      - :Draft
      - :Deleted
      - :Seen
      - "$Forwarded"
      - "$Junk"
      - "$MailFlagBit0"
      - "$MailFlagBit2"
      - "$NotJunk"
      - "$NotPhishing"
      - "$Phishing"
      - Forwarded
      - JunkRecorded
      - NotJunk
      - OIB-Seen-INBOX
      - OIB-Seen-Unsubscribe
      - OIB-Seen-[Google
      - Mail]/Alle
      - Nachrichten
      raw_data: "* FLAGS (\\Answered \\Flagged \\Draft \\Deleted \\Seen $Forwarded
        $Junk $MailFlagBit0 $MailFlagBit2 $NotJunk $NotPhishing $Phishing Forwarded
        JunkRecorded NotJunk OIB-Seen-INBOX OIB-Seen-Unsubscribe OIB-Seen-[Google
        Mail]/Alle Nachrichten)\r\n"

  "greenmail sent \"\\*\" in a FLAGS response":
    comment: |
      net-imap issue: https://github.com/ruby/net-imap/issues/228

      Greenmail did fix their bug very quickly after it was reported. :)
      Upstream issue: https://github.com/greenmail-mail-test/greenmail/issues/633

      Also, greenmail is a testing fake server and I haven't seen any evidence
      of any "real" servers with this exact error yet. So I don't feel that it's
      critical to be compatible with it.  But, since we needed the workaround
      anyway, for #241, it's reasonable to document that it handles this too.
    :response: "* FLAGS (\\Answered \\Deleted \\Draft \\Flagged \\Seen \\*)\r\n"
    expect_rescued_error: true
    :expected: !ruby/struct:Net::IMAP::UntaggedResponse
      name: FLAGS
      data:
      - :Answered
      - :Deleted
      - :Draft
      - :Flagged
      - :Seen
      - :*
      raw_data: "* FLAGS (\\Answered \\Deleted \\Draft \\Flagged \\Seen \\*)\r\n"
